//var DataDescription =
 
//{
//	controlType:null,
//	dataType:null
//}

	function showImageBrowser(position, rootFolder)
	{
		var holder = $('<div id="folderBrowser">');
		holder.css("left", position.left);
		holder.css("top", position.top);
		$.fn.loadContent("folder", function(result)
		{
			$(result).find("row").first().children().each(function(){
				var pic = $('<img />');
				pic.attr("class","folderBrowsePic"); 
				pic.attr("src",$(this).text()); 
				pic.click(function(){
					$("#picUrl_edit").attr("src", $(this).attr("src"));
					holder.remove();
				});
				holder.append(pic);
			});
//			$("#menuPriority").attr("value", $(result).find( 'priority' ).first().text());
		}, {"assetFolder":rootFolder}, "xml");
		$("body").append(holder);
	}
	
	function destroyImageBrwoser()
	{
		var holder = $("#folderBrowser");
		if(null!=holder)
			holder.remove();
	}

/********************************************************************************************
 *  Controls
 ********************************************************************************************/
var DataEntity = function(n, h, d)
{
	this.name = n;
	this.helpString = h;
	this.staticPresetData = d;
	this.control = null;
};
DataEntity.prototype.createControl = function(doc, presetValues)
{
	return this.control;
}
DataEntity.prototype.init = function(presetValues)
{
}
DataEntity.prototype.create = function(doc, presetValues, presetOptions)
{
	var controlDiv = doc.createElement("div");
	controlDiv.setAttribute("class", "controlDiv");
	var label = doc.createElement("div");
	label.setAttribute("class", "creationLabel");
	label.innerHTML = this.name;
	controlDiv.appendChild(label);
	
	var theControl = this.createControl(doc, presetValues, presetOptions);
	if(null!=theControl)
		controlDiv.appendChild(theControl);
	
	var helpIcon = doc.createElement("img");
	helpIcon.setAttribute("class", "helpIcon");
	helpIcon.setAttribute("src", "../../images/images/question_mark.png");
	controlDiv.setAttribute("title", this.helpString);
	controlDiv.appendChild(helpIcon);
	
	return controlDiv;
}
DataEntity.prototype.destroy = function()
{
};

////////////////////////////////////////////////////////////////////////////////////////
var TextField = function(n, h, d)
{
	// contructor
	DataEntity.call(this, n, h, d);
}
TextField.prototype = new DataEntity;
TextField.prototype.createControl = function(doc, presetValues)
{
	this.control =  doc.createElement("input");
	this.control.setAttribute("type", "text");
	this.control.setAttribute("id", this.name+"_edit");
	this.control.setAttribute("class", "creationControl");
	if(null!=presetValues && null!=presetValues[this.name])
	{
		this.control.value = presetValues[this.name];
	}
	return this.control;
}

TextField.prototype.getData = function(data)
{
	data[this.name] = this.control.value;
}
////////////////////////////////////////////////////////////////////////////////////////
var TextArea = function(n, h, d)
{
	// contructor
	DataEntity.call(this, n, h, d);
}
TextArea.prototype = new DataEntity;
TextArea.prototype.createControl = function(doc, presetValues)
{
	this.control =  doc.createElement("textarea");
	this.control.setAttribute("id", this.name+"_edit");
	this.control.setAttribute("class", "creationControl");
	if(null!=presetValues && null!=presetValues[this.name])
	{
		this.control.value = presetValues[this.name];
	}
	return this.control;
}

TextArea.prototype.getData = function(data)
{
	data[this.name] = this.control.value;
}
////////////////////////////////////////////////////////////////////////////////////////
var ComboBox = function(n, h, d, returnIndex)
{
	this.returnIndex = returnIndex;
	// contructor
	DataEntity.call(this, n, h, d);
}
ComboBox.prototype = new DataEntity;
ComboBox.prototype.createControl = function(doc, presetValues, presetOptions)
{
	this.control =  doc.createElement("select");
	this.control.setAttribute("id", this.name+"_edit");
	this.control.setAttribute("class", "creationControl");
	if(null!=presetOptions && null!=presetOptions[this.name])
		this.staticPresetData = presetOptions[this.name];
	if(null!=this.staticPresetData)
	{
		var entries = this.staticPresetData.split(",");
		for(e in entries)
		{
			optn = document.createElement("OPTION");
			optn.textContent = entries[e];
			this.control.appendChild(optn);
		}
	}
	if(null!=presetValues && null!=presetValues[this.name])
	{
		this.control.value = presetValues[this.name];
	}
	return this.control;
}

ComboBox.prototype.getData = function(data)
{
	if(this.returnIndex)
		data[this.name] = this.control.selectedIndex;
	else
		data[this.name] = this.control.value;
}

////////////////////////////////////////////////////////////////////////////////////////
var Spinner = function(n, h, d)
{
	// contructor
	DataEntity.call(this, n, h, d);
}
Spinner.prototype = new DataEntity;
Spinner.prototype.createControl = function(doc, presetValues)
{
	this.control =  doc.createElement("input");
	this.control.setAttribute("type", "text");
	var myId = this.name+"_edit";
	this.control.setAttribute("id", myId);
	this.control.setAttribute("class", "creationControl");
	this.control.setAttribute("value","");
	if(null!=presetValues && null!=presetValues[this.name])
	{
		this.control.setAttribute("value", presetValues[this.name]);
	}
	return this.control;
}
Spinner.prototype.init = function(presetValues)
{
	$(this.control).spinner();
	if(null!=presetValues && null!=presetValues[this.name])
	{
		$(this.control).spinner("value", presetValues[this.name]);
	}
	else if(null!=this.staticPresetData)
	{
		$(this.control).spinner("value", this.staticPresetData);
	}
	else if(this.control.getAttribute("value")=="")
		$(this.control).spinner("value", 300);
}

Spinner.prototype.getData = function(data)
{
	data[this.name] = this.control.value;
}
////////////////////////////////////////////////////////////////////////////////////////
var DateField = function(n, h, d)
{
	// contructor
	DataEntity.call(this, n, h, d);
}
DateField.prototype = new DataEntity;
DateField.prototype.createControl = function(doc, presetValues)
{
	this.control =  doc.createElement("input");
	this.control.setAttribute("type", "text");
	var myId = this.name+"_edit";
	this.control.setAttribute("id", myId);
	this.control.setAttribute("class", "creationControl");
	this.control.setAttribute("value","");
	if(null!=presetValues && null!=presetValues[this.name])
	{
		this.control.setAttribute("value", presetValues[this.name]);
	}
	return this.control;
}
DateField.prototype.init = function()
{
	$(this.control).datepicker({dateFormat:'yy-mm-dd'});
//	if(this.control.getAttribute("value")=="")
//		$(this.control).datepicker("value", 300);
}

DateField.prototype.getData = function(data)
{
	data[this.name] = this.control.value;
}
////////////////////////////////////////////////////////////////////////////////////////
var TimeField = function(n, h, d)
{
	// contructor
	DataEntity.call(this, n, h, d);
}
TimeField.prototype = new DataEntity;
TimeField.prototype.createControl = function(doc, presetValues)
{
	this.control =  doc.createElement("input");
	this.control.setAttribute("type", "text");
	var myId = this.name+"_edit";
	this.control.setAttribute("id", myId);
	this.control.setAttribute("class", "creationControl");
	this.control.setAttribute("value","");
	if(null!=presetValues && null!=presetValues[this.name])
	{
		this.control.setAttribute("value", presetValues[this.name]);
	}
	else
		this.control.setAttribute("value", "19:00:00");

	return this.control;
}
TimeField.prototype.init = function()
{
}

TimeField.prototype.getData = function(data)
{
	data[this.name] = this.control.value;
}

////////////////////////////////////////////////////////////////////////////////////////
var WYSIWYGField = function(n, h, d)
{
	// contructor
	DataEntity.call(this, n, h, d);
}
WYSIWYGField.prototype = new DataEntity;
WYSIWYGField.prototype.createControl = function(doc, presetValues)
{
//	if(null!=$('textarea:tinymce'))
//		$('textarea:tinymce').execCommand('mceRemoveControl',false, (this.name+"_edit") );
//	if(this.control == null)
	{
		this.control = doc.createElement("textarea");
	}
	var myId = this.name+"_edit";
	this.control.setAttribute("id", myId);
	return this.control;
}
function createMce(on)
{
	on.tinymce({
		// Location of TinyMCE script
		script_url : '../../script/tiny_mce/tiny_mce.js',

		// General options
		theme : "advanced",

		// Theme options
		theme_advanced_toolbar_location : "top",
		theme_advanced_toolbar_align : "left",
		theme_advanced_statusbar_location : "bottom",
		theme_advanced_resizing : true

/*
		plugins : "autolink,lists,pagebreak,style,layer,table,save,advhr,advimage,advlink,emotions,iespell,inlinepopups,insertdatetime,preview,media,searchreplace,print,contextmenu,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras,template,advlist",
		theme_advanced_buttons1 : "save,newdocument,|,bold,italic,underline,strikethrough,|,justifyleft,justifycenter,justifyright,justifyfull,styleselect,formatselect,fontselect,fontsizeselect",
		theme_advanced_buttons2 : "hr,removeformat,visualaid,|,sub,sup,|,charmap,emotions,iespell,media,advhr,|,print,|,ltr,rtl,|,fullscreen",

		content_css : "rnr.localhost/css/mainStyles.css"

		plugins : "autolink,lists,pagebreak,style,layer,table,save,advhr,advimage,advlink,emotions,iespell,inlinepopups,insertdatetime,preview,media,searchreplace,print,contextmenu,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras,template,advlist",
		theme_advanced_buttons1 : "save,newdocument,|,bold,italic,underline,strikethrough,|,justifyleft,justifycenter,justifyright,justifyfull,styleselect,formatselect,fontselect,fontsizeselect",
		theme_advanced_buttons2 : "cut,copy,paste,pastetext,pasteword,|,search,replace,|,bullist,numlist,|,outdent,indent,blockquote,|,undo,redo,|,link,unlink,anchor,image,cleanup,help,code,|,insertdate,inserttime,preview,|,forecolor,backcolor",
		theme_advanced_buttons3 : "tablecontrols,|,hr,removeformat,visualaid,|,sub,sup,|,charmap,emotions,iespell,media,advhr,|,print,|,ltr,rtl,|,fullscreen",
		theme_advanced_buttons4 : "insertlayer,moveforward,movebackward,absolute,|,styleprops,|,cite,abbr,acronym,del,ins,attribs,|,visualchars,nonbreaking,template,pagebreak",
		// Example content CSS (should be your site CSS)

		// Drop lists for link/image/media/template dialogs
		template_external_list_url : "lists/template_list.js",
		external_link_list_url : "lists/link_list.js",
		external_image_list_url : "lists/image_list.js",
		media_external_list_url : "lists/media_list.js",

		// Replace values for the template plugin
		template_replace_values : {
			username : "Some User",
			staffid : "991234"
		},
*/
	});
}
WYSIWYGField.prototype.init = function(presetValues)
{
	var thevalue = "";
	if(null!=presetValues && null!=presetValues[this.name])
	{
		thevalue = presetValues[this.name];
	}
	else if(null!=this.staticPresetData)
	{
		thevalue = this.staticPresetData;
	}
	if(thevalue!=null)
	{
		// taking the <div> off.
		thevalue = $(thevalue).unwrap().html();
	}
	$(this.control).css("visibility", "visible");
	createMce($(this.control));

	//this.control.setAttribute("value", thevalue);
	//$(selector).tinymce().setContent(thevalue);
	$(this.control).html(thevalue);
}

WYSIWYGField.prototype.getData = function(data)
{
//	alert($(this.control).tinymce().getContent());
	var wrapper = $("<div><div /></div>");
	wrapper.children().first().append($(this.control).tinymce().getContent());
	data[this.name] = wrapper.html();
//	alert(data[this.name]);
}
WYSIWYGField.prototype.destroy = function(presetValues)
{
//	$(this.control).tinymce().removeControl();
//	$("#"+this.name+"_edit_parent").remove();
//	alert("destroy editor");
}

////////////////////////////////////////////////////////////////////////////////////////
var PicBrowse = function(n, h, d)
{
	// contructor
	DataEntity.call(this, n, h, d);
}
PicBrowse.prototype = new DataEntity;
PicBrowse.prototype.createControl = function(doc, presetValues)
{
	var holder =  doc.createElement("div");
	holder.setAttribute("class", "picBrowseHolder");
	
	var browseLink = doc.createElement("input");
	browseLink.setAttribute("type", "button");
	browseLink.setAttribute("id", "browseLink");
	browseLink.setAttribute("value", "browse");
	holder.appendChild(browseLink);

	var uploadTarget = doc.createElement("iframe");
	uploadTarget.setAttribute("id", "uploadTarget");
	uploadTarget.setAttribute("name", "uploadTarget");
	uploadTarget.setAttribute("align", "right");
	
	var uploadForm = doc.createElement("form");
	uploadForm.setAttribute("action", "fileupload.php");
	uploadForm.setAttribute("method", "POST");
	uploadForm.setAttribute("id", "uploadForm");
	uploadForm.setAttribute("target", "uploadTarget");
	uploadForm.setAttribute("enctype", "multipart/form-data");
	holder.appendChild(uploadForm);
	
	var uploadLink = doc.createElement("input");
	uploadLink.setAttribute("type", "file");
	uploadLink.setAttribute("id", "uploadedfile");
	uploadLink.setAttribute("name", "uploadedfile");
	uploadLink.setAttribute("align", "right");
	uploadForm.appendChild(uploadLink);

	var uploadSubmit = doc.createElement("input");
	uploadSubmit.setAttribute("type", "submit");
	uploadSubmit.setAttribute("id", "uploadSubmit");
	uploadSubmit.setAttribute("value", "OK");
	uploadForm.appendChild(uploadSubmit);

	holder.appendChild(uploadTarget);
	holder.innerHTML += "<br />";
	
	this.control =  doc.createElement("img");
	var myId = this.name+"_edit";
	this.control.setAttribute("id", myId);
	this.control.setAttribute("class", "creationControl");
	this.control.setAttribute("src","");
	if(null!=presetValues && null!=presetValues[this.name])
	{
		this.control.setAttribute("src", presetValues[this.name]);
	}
	holder.appendChild(this.control);
		
	return holder;
}
PicBrowse.prototype.init = function()
{
	$("#browseLink").click(function(){
		showImageBrowser($(this).offset(), "images");
	});
}

PicBrowse.prototype.getData = function(data)
{
	data[this.name] = $(this.control).attr("src");
}

////////////////////////////////////////////////////////////////////////////////////////
/********************************************************************************************
 *  Group
 ********************************************************************************************/

var Group = function(n, h) 
{
	// contructor
	DataEntity.call(this, n, h);
	this.controls = [];
};
Group.prototype = new DataEntity;
Group.prototype.init = function(presetValues)
{
	for(d in this.controls)
	{
		this.controls[d].init(presetValues);
	}
};
Group.prototype.create = function(doc, presetValues, presetOptions)
{
	this.control = doc.createElement("fieldset");
	this.control.setAttribute("id", this.name+"_edit");
	var boxLegend = doc.createElement("legend");
	boxLegend.innerHTML = this.helpString;
	this.control.appendChild(boxLegend);
	for(d in this.controls)
	{
		this.control.appendChild(this.controls[d].create(doc, presetValues, presetOptions));
	}
	
	return this.control;
};

Group.prototype.getData = function(data)
{
	for(d in this.controls)
	{
		this.controls[d].getData(data);
	}
};
Group.prototype.destroy = function()
{
	for(d in this.controls)
	{
		this.controls[d].destroy();
	}
};

/********************************************************************************************
 *  EditDialog
 ********************************************************************************************/
var EditDialog = function(n, h) 
{
	// contructor
	Group.call(this, n, h);
};
EditDialog.prototype = new Group;
EditDialog.prototype.createDialog = function(doc, callback, presetValues, presetOptions)
{
	this.closeMe = function()
	{
		destroyImageBrwoser();
		dialogInst.destroy();
		removeDialog();
	};
	this.confirm = function()
	{
		callback();
		dialogInst.closeMe();
	};

	var bg = doc.createElement("div");
	bg.setAttribute("id","creationBg");
	var holder = doc.createElement("div");
	holder.setAttribute("class","creationBox");

	var childControls = this.create(doc, presetValues, presetOptions);
	holder.appendChild(childControls);

	var createButton = doc.createElement("input");
	createButton.setAttribute("type", "button");
	createButton.setAttribute("style", "float:right;");
	createButton.setAttribute("value", "Create");
	holder.appendChild(createButton);
	$(createButton).click(this.confirm);
	
	var cancelButton = doc.createElement("input");
	cancelButton.setAttribute("type", "button");
	cancelButton.setAttribute("style", "float:left;");
	cancelButton.setAttribute("value", "Cancel");
	holder.appendChild(cancelButton);
	var dialogInst = this;
	$(cancelButton).click(this.closeMe);

	$("body").append(bg);
	$("body").append(holder);
	var newLeft = $(window).width()/2 - parseInt($(".creationBox").css("width"))/2;
	var newTop = 20;//$(window).height()/2 - parseInt($(".creationBox").css("height"))/2;
	$(".creationBox").css("left", newLeft);
	$(".creationBox").css("top", newTop);
	this.init(presetValues);
};
function removeDialog()
{
	$("#creationBg").remove();
	$(".creationBox").remove();
};

/********************************************************************************************
 *  Uses
 ********************************************************************************************/

var PageCreationDialog = new EditDialog("PageCreationDialog", "Neuen Inhalt einfuegen");
PageCreationDialog.controls = new Array(
		new TextField("identifier", 		 "Die Ueberschrift fuer die Seite."),
		new TextField("menuTitle", "Der Titel im Menu falls gewuenscht."),
		new Spinner("priority", "Die Reihenfolge im Menu.", 0)
);
////////////////////////////////////////////////////////////////////////////////////////////////////////
var SubMenuCreationDialog = new EditDialog("SubMenuCreationDialog", "Neuen Menueintrag einfuegen");
SubMenuCreationDialog.controls = new Array(
		new TextField("title", "Der Titel der im Menu angezeigt wird."),
		new ComboBox("url",  "Der Textanker-link auf das der Eintrag verweist.")
);
////////////////////////////////////////////////////////////////////////////////////////////////////////
var ParagraphCreationDialog = new EditDialog("ParagraphCreationDialog", "Neuen Absatz erstellen");
var PicTextGroup = new Group("picTextGroup", "Absatz spezifische Inhalte");
PicTextGroup.controls = new Array(
		new PicBrowse("picUrl", "Verwendetes Bild."),
		new TextField("picTitle", "Untertitel des verwendeten Bildes."),
		new WYSIWYGField("content",  "Der Inhaltstext.")
);
var TableGroup = new Group("tableGroup", "Absatz spezifische Inhalte");
TableGroup.controls = new Array(
		new ComboBox("table", "Die verwendete Tabelle.", " ,events, links"),
		new ComboBox("category",  "Kategorie oder Monat.")
);
var TableTypeStrings = ["Text mit Bild rechts","Text mit Bild links","Tabelle"];
ParagraphCreationDialog.controls = new Array(
		new TextField("title", "Der Titel des Absatzes."),
		new ComboBox("type",  "Typ des verwendeten Layouts.", TableTypeStrings.join(",")),
		new Spinner("height", "Hoehe des Absatz."),
		PicTextGroup,
		TableGroup
);
function toggleGroup()
{
	var index = $("#type_edit").attr("selectedIndex"); 
	if(index==2)
	{
		$("#picTextGroup_edit").css("visibility", "hidden");
		$("#tableGroup_edit").css("visibility", "visible");
	}
	else
	{
		$("#picTextGroup_edit").css("visibility", "visible");
		$("#tableGroup_edit").css("visibility", "hidden");
	}
}
function getCategoryCallback(result)
{
	$(TableGroup.controls[1].control).empty();
	
	$(result).find("category").each(function(){
		optn = document.createElement("OPTION");
		optn.textContent = $(this).text();
//		this.control.appendChild(optn);
		$(TableGroup.controls[1].control).append(optn);
	});
}
ParagraphCreationDialog.init = function(presetValues)
{
	$(this.controls[1].control).change(toggleGroup);
	Group.prototype.init.call(this, presetValues);
};
TableGroup.init = function()
{
	this.control.setAttribute("style", "visibility:hidden;");
	$(this.controls[0].control).change(function(){
		var table = $(this).attr("value");
		$.fn.loadContent(table, getCategoryCallback, null, "data", {selector:"DISTINCT category"});
	});
}
////////////////////////////////////////////////////////////////////////////////////////////////////////
var TableEntryDialog = new EditDialog("TableEntryDialog", "In Tabelle einfuegen.");
TableEntryDialog.controls = new Array(
		new ComboBox("category",  "Die Kategorie des Eintrages."),
		new TextField("newCategory",  "Neue Kategorie erstellen. Ueberschreibt obige Auswahl."),
		new TextField("title", "Der Titel des Eintrages."),
		new PicBrowse("pic", "Event Bild"),
		new DateField("date", "Das Datum des Events."),
		new ComboBox("type",  "Typ der Veranstaltung.", "Ausstellung,Konzert,Jubilaeum", true),
		new TextField("description", "Beschreibung des Events."),
		new TextField("venue", "Ort des Events."),
		new TimeField("time", "Anfangszeit des Events."),
		new TextField("misc", "Verschiedenes ueber das Event.")
);
TableEntryDialog.init = function(initData)
{
	$.fn.loadContent(initData['table'], function(result)
	{
		$(result).find("category").each(function(){
			optn = document.createElement("OPTION");
			optn.textContent = $(this).text();
			$(TableEntryDialog.controls[0].control).append(optn);
		});
	}, null, "data", {selector:"DISTINCT category"});
}